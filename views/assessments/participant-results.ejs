<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/stylesheets/style.css" />
    <!-- ✅ NEW: Use embedded participant name -->
    <title><%= participant.name %> - Results</title>
</head>
<body>
    <%- include('../partials/_navbar.ejs') %>
    <div class="page-container">
        <div class="page-header">
            <!-- ✅ NEW: Use embedded participant name -->
            <h1><%= assessment.title %> – <%= participant.name %></h1>
            <a href="/users/<%= user._id %>/assessments/<%= assessment._id %>/group-results" class="button app-button">← Back to Group Results</a>
        </div>

        <div class="section">
            <!-- ✅ NEW: Updated section title for clarity -->
            <h2>Perception Accuracy for <%= participant.name %></h2>
            <p>How <%= participant.name %> thinks others feel about them vs. reality:</p>
            
            <table class="matrix-table">
                <thead>
                    <tr>
                        <th>Participant</th>
                        <th>Believes They Feel</th>
                        <th>They Actually Feel</th>
                        <th>Match?</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- ✅ NEW: Use perceivedByOthers instead of emissionMatrix -->
                    <% if (assessment.perceivedByOthers && assessment.perceivedByOthers.entries) { %>
                        <% assessment.perceivedByOthers.entries
                            .filter(entry => entry.from === participantIndex)
                            .forEach(entry => { %>
                            <% 
                                // ✅ NEW: Find actual preference from participantPreferences
                                const actualPreference = assessment.participantPreferences && assessment.participantPreferences.entries ? 
                                    assessment.participantPreferences.entries.find(
                                        p => p.from === entry.to && p.to === participantIndex
                                    ) : null;
                                const isMatch = actualPreference && actualPreference.sentiment === entry.sentiment;
                            %>
                            <tr>
                                <!-- ✅ NEW: Use embedded participants array -->
                                <th><%= assessment.participants[entry.to].name %></th>
                                <td class="<%= entry.sentiment %>">
                                    <%= entry.sentiment.charAt(0).toUpperCase() + entry.sentiment.slice(1) %>
                                </td>
                                <td class="<%= actualPreference ? actualPreference.sentiment : '' %>">
                                    <% if (actualPreference) { %>
                                        <%= actualPreference.sentiment.charAt(0).toUpperCase() + actualPreference.sentiment.slice(1) %>
                                    <% } else { %>
                                        N/A
                                    <% } %>
                                </td>
                                <td class="<%= isMatch ? 'match' : 'mismatch' %>">
                                    <%= isMatch ? '✓' : '✗' %>
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="4">No perception data available</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>Summary Metrics</h2>
            
            <table class="matrix-table">
                <tbody>
                    <tr>
                        <th>Mutualities</th>
                        <!-- ✅ NEW: Use calculated data from controller -->
                        <td><%= participant.mutualitiesCount %></td>
                    </tr>
                    <tr>
                        <th>Incongruities</th>
                        <td><%= participant.incongruitiesCount %></td>
                    </tr>
                    <tr>
                        <td colspan="2"></td>
                    </tr>
                    <tr>
                        <th>Perception Index</th>
                        <!-- ✅ NEW: Display as fraction instead of decimal -->
                        <td><%= participant.perceptionIndex %>/<%= assessment.participants.length - 1 %></td>
                    </tr>
                    <tr>
                        <th>Emission Index</th>
                        <!-- ✅ NEW: Display as fraction instead of decimal -->
                        <td><%= participant.emissionIndex %>/<%= assessment.participants.length - 1 %></td>
                    </tr>
                    <tr>
                        <th>Telic Index</th>
                        <!-- ✅ NEW: Display telic index with context -->
                        <td><%= participant.telicIndex.toFixed(2) %>/<%= assessment.participants.length - 1 %></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ✅ NEW: Optional section for detailed breakdown -->
        <div class="section">
            <h2>Detailed Totals</h2>
            
            <table class="matrix-table">
                <tbody>
                    <tr>
                        <th>Positive Received</th>
                        <td><%= participant.positiveTotal %></td>
                    </tr>
                    <tr>
                        <th>Neutral Received</th>
                        <td><%= participant.neutralTotal %></td>
                    </tr>
                    <tr>
                        <th>Negative Received</th>
                        <td><%= participant.negativeTotal %></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>